unit endereco.service;

interface

uses files.interfaces, FireDAC.Comp.Client, XMLDoc, Xml.XMLIntf,
  System.SysUtils, System.JSON, System.MaskUtils,
  viaCEP.component, endereco.model;

type
  TEnderecoService = class
  public
    class function getEnderecoDB(uf, cidade, endereco, cep: String;
      connection: TFDConnection): TJSONObject; static;

    class procedure save(obj: iFiles; connection: TFDConnection); static;
    class procedure update(obj: iFiles; connection: TFDConnection); static;

    class function getByCEP(cep: String; connection: TFDConnection)
      : TJSONObject; static;

    class function getByEndereco(uf, cidade, endereco: String;
      connection: TFDConnection): TJSONObject; overload;

    class function getByEndereco(uf, cidade, endereco: String;
      connection: TFDConnection): IXMLDocument; overload;
  end;

implementation

{ TEnderecoService }
class function TEnderecoService.getEnderecoDB(uf, cidade, endereco, cep: String;
  connection: TFDConnection): TJSONObject;
var
  qry: TFDQuery;
begin
  result := nil;
  qry := TFDQuery.Create(nil);

  try
    qry.connection := connection;

    qry.Close;
    qry.SQL.Clear;
    qry.SQL.Add('SELECT *             ');
    qry.SQL.Add('  FROM ENDERECOS E   ');
    qry.SQL.Add(' WHERE 1 = 1         ');

    if not SameText(Trim(cep), EmptyStr) then
    begin
      qry.SQL.Add('   AND E.CEP = :CEP  ');
      qry.ParamByName('CEP').AsString := FormatMaskText('00000\-000;0;', cep);
    end;

    if (not SameText(Trim(uf), EmptyStr)) and
      (not SameText(Trim(cidade), EmptyStr)) and
      (not SameText(Trim(endereco), EmptyStr)) then
    begin
      qry.SQL.Add('   AND E.UF = :UF                    ');
      qry.SQL.Add('   AND E.LOCALIDADE = :LOCALIDADE    ');
      qry.SQL.Add('   AND E.LOGRADOURO = :LOGRADOURO  ');
      qry.ParamByName('UF').AsString := uf;
      qry.ParamByName('LOCALIDADE').AsString := cidade;
      qry.ParamByName('LOGRADOURO').AsString := StringReplace(endereco, '+',
        ' ', [rfReplaceAll, rfIgnoreCase]);
    end;

    qry.Open;

    if not qry.IsEmpty then
    begin
      result := TJSONObject.Create;
      result.AddPair('codigo', qry.FieldByName('codigo').AsString);
      result.AddPair('cep', qry.FieldByName('cep').AsString);
      result.AddPair('logradouro', qry.FieldByName('logradouro').AsString);
      result.AddPair('complemento', qry.FieldByName('complemento').AsString);
      result.AddPair('bairro', qry.FieldByName('bairro').AsString);
      result.AddPair('localidade', qry.FieldByName('localidade').AsString);
      result.AddPair('uf', qry.FieldByName('uf').AsString);
    end
  finally
    qry.Close;
    FreeAndNil(qry);
  end;
end;

class function TEnderecoService.getByCEP(cep: String; connection: TFDConnection)
  : TJSONObject;
var
  JSON: TJSONObject;
  vViaCep: TViaCepComponent;
begin
  vViaCep := TViaCepComponent.Create(nil);

  try
    vViaCep.cep := cep;
    vViaCep.uf := EmptyStr;
    vViaCep.cidade := EmptyStr;
    vViaCep.endereco := EmptyStr;

    result := TJSONObject(vViaCep.getJSONByCEP);
  finally
    FreeAndNil(vViaCep);
  end;
end;

class function TEnderecoService.getByEndereco(uf, cidade, endereco: String;
  connection: TFDConnection): TJSONObject;
var
  vViaCep: TViaCepComponent;
  JSON: TJSONObject;
  JSONArray: TJSONArray;
begin
  vViaCep := TViaCepComponent.Create(nil);

  try
    vViaCep.cep := EmptyStr;
    vViaCep.uf := uf;
    vViaCep.cidade := cidade;
    vViaCep.endereco := endereco;

    JSON := TJSONObject(vViaCep.getJSONByEndereco);

    JSONArray := TJSONValue(JSON) as TJSONArray;

    { Como a consulta por endereco pode retornar mais de um endereço,
      será realizada uma serie de conversões para que possamos recuperar
      o primeiro da lista. Como sugestão futura, criar mecanismo para que o
      usuario possa selecionar o endereço dentre os retornados }
    result := TJSONObject(JSONArray[0]);
  finally
    FreeAndNil(vViaCep);
  end;
end;

class procedure TEnderecoService.save(obj: iFiles; connection: TFDConnection);
var
  qry: TFDQuery;
begin
  qry := TFDQuery.Create(nil);

  try
    qry.connection := connection;

    qry.Close;
    qry.SQL.Clear;
    qry.SQL.Add('INSERT INTO consultacep.enderecos(CEP,          ');
    qry.SQL.Add('                                  LOGRADOURO,   ');
    qry.SQL.Add('                                  COMPLEMENTO,  ');
    qry.SQL.Add('                                  BAIRRO,       ');
    qry.SQL.Add('                                  LOCALIDADE,   ');
    qry.SQL.Add('                                  UF)           ');
    qry.SQL.Add('                           VALUES(:CEP,         ');
    qry.SQL.Add('                                  :LOGRADOURO,  ');
    qry.SQL.Add('                                  :COMPLEMENTO, ');
    qry.SQL.Add('                                  :BAIRRO,      ');
    qry.SQL.Add('                                  :LOCALIDADE,  ');
    qry.SQL.Add('                                  :UF)          ');
    qry.ParamByName('CEP').AsString := TEndereco(obj).cep;
    qry.ParamByName('LOGRADOURO').AsString := TEndereco(obj).Logradouro;
    qry.ParamByName('COMPLEMENTO').AsString := TEndereco(obj).Complemento;
    qry.ParamByName('BAIRRO').AsString := TEndereco(obj).Bairro;
    qry.ParamByName('LOCALIDADE').AsString := TEndereco(obj).Localidade;
    qry.ParamByName('UF').AsString := TEndereco(obj).uf;
    qry.ExecSQL;
  finally
    qry.Close;
    FreeAndNil(qry);
  end;
end;

class procedure TEnderecoService.update(obj: iFiles; connection: TFDConnection);
var
  qry: TFDQuery;
begin
  qry := TFDQuery.Create(nil);

  try
    qry.connection := connection;

    qry.Close;
    qry.SQL.Clear;
    qry.SQL.Add('UPDATE consultacep.enderecos       ');
    qry.SQL.Add('   SET CEP         = :CEP,         ');
    qry.SQL.Add('       LOGRADOURO  = :LOGRADOURO,  ');
    qry.SQL.Add('       Complemento = :COMPLEMENTO, ');
    qry.SQL.Add('       Bairro      = :BAIRRO,      ');
    qry.SQL.Add('       Localidade  = :LOCALIDADE,  ');
    qry.SQL.Add('       UF          = :UF           ');
    qry.SQL.Add(' WHERE CODIGO      = :CODIGO;      ');
    qry.ParamByName('CODIGO').AsInteger := TEndereco(obj).Codigo;
    qry.ParamByName('CEP').AsString := TEndereco(obj).cep;
    qry.ParamByName('LOGRADOURO').AsString := TEndereco(obj).Logradouro;
    qry.ParamByName('COMPLEMENTO').AsString := TEndereco(obj).Complemento;
    qry.ParamByName('BAIRRO').AsString := TEndereco(obj).Bairro;
    qry.ParamByName('LOCALIDADE').AsString := TEndereco(obj).Localidade;
    qry.ParamByName('UF').AsString := TEndereco(obj).uf;
    qry.ExecSQL;
  finally
    qry.Close;
    FreeAndNil(qry);
  end;
end;

end.
